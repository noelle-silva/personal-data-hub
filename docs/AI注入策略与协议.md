# AI 注入策略与协议

## 概述

本文档描述了个人数据系统中 AI 聊天功能的笔记/收藏夹内容注入机制的设计与实现。

## 问题背景

在原始实现中，笔记/收藏夹内容会直接拼接到用户消息中，这导致了以下问题：

1. **重复注入**：每次对话都会将注入内容保存到聊天历史，导致后续对话中出现重复的注入内容
2. **上下文浪费**：重复的注入内容占用了宝贵的上下文窗口
3. **历史污染**：聊天历史记录中包含了大量重复的注入标记

## 解决方案：临时注入协议

### 设计原则

1. **临时性**：注入内容仅在当前轮次有效，不保存到历史记录
2. **清晰分离**：注入内容与用户消息在协议层面分离
3. **向后兼容**：保留兜底机制以兼容旧版本

### 协议实现

#### 前端实现

```javascript
// 请求参数结构
const requestParams = {
  messages: [
    { role: 'user', content: '用户原始消息' },
    // ... 其他历史消息
  ],
  model: 'gpt-4o-mini',
  temperature: 0.7,
  // 临时注入字段
  ephemeral_injection: {
    type: 'document', // 或 'quote'
    content: '—————当前笔记————\n笔记内容\n—————当前笔记如上————'
  }
};
```

#### 后端处理流程

1. **接收请求**：解析 `ephemeral_injection` 字段
2. **保存历史**：仅保存原始用户消息到数据库
3. **应用注入**：在发送给 AI 模型前，将注入内容拼接到最后一条用户消息
4. **截断处理**：在应用注入后进行上下文截断

### AI 模型视角

```json
{
  "messages": [
    {"role": "system", "content": "系统提示词"},
    {"role": "user", "content": "用户消息1"},
    {"role": "assistant", "content": "AI回复1"},
    {"role": "user", "content": "—————当前笔记————\n笔记内容\n—————当前笔记如上————\n\n用户消息2"}
  ]
}
```

## 兜底机制

为了兼容旧版本前端，后端实现了注入内容剥离机制：

```javascript
// 剥离模式
const notePattern = /—————当前笔记————[\s\S]*?—————当前笔记如上————/g;
const quotePattern = /—————当前收藏夹————[\s\S]*?—————当前收藏夹如上————/g;
```

## 调试与监控

### 环境变量

设置 `DEBUG_EPHEMERAL_INJECTION=true` 可启用详细日志：

```bash
export DEBUG_EPHEMERAL_INJECTION=true
```

### 日志输出示例

```
[DEBUG] 临时注入应用: {
  type: "document",
  injectionLength: 156,
  originalLength: 23,
  finalLength: 181
}

[DEBUG] 兜底剥离注入内容: {
  originalLength: 181,
  cleanedLength: 23,
  stripped: 158
}
```

## 使用场景

### 笔记注入

当用户在笔记窗口中开启 AI 聊天并启用注入时：

```javascript
// 注入内容格式
`—————当前笔记————
${笔记内容}
—————当前笔记如上————`
```

### 收藏夹注入

当用户在收藏夹窗口中开启 AI 聊天并启用注入时：

```javascript
// 注入内容格式
`—————当前收藏夹————
${收藏夹内容}
—————当前收藏夹如上————`
```

## 技术细节

### 关键文件

- **前端**：`frontend/src/components/AIChatPanel.jsx`
- **后端**：`backend/controllers/aiController.js`

### 核心方法

1. `buildInjectionContent()` - 构建注入内容
2. `stripInjectionContent()` - 兜底剥离注入内容
3. `createChatCompletion()` - 处理临时注入协议

### 数据流

```
用户输入 → 前端构建请求 → 后端保存历史 → 应用临时注入 → 发送给AI → 返回响应
```

## 注意事项

1. **注入开关**：用户可以通过 UI 开关控制是否启用注入
2. **上下文限制**：注入内容会计入上下文 Token 限制
3. **多轮对话**：每轮对话只有最新的用户消息会被注入
4. **历史回放**：历史记录中不包含注入内容，保持干净

## 未来扩展

1. **多种注入类型**：可扩展支持更多类型的注入内容
2. **注入权重**：可为不同类型的注入设置不同权重
3. **智能注入**：根据对话内容智能判断是否需要注入
4. **注入模板**：支持自定义注入内容模板

## 版本历史

- **v1.0**：基础注入实现（存在重复问题）
- **v2.0**：临时注入协议（当前版本）
  - 修复重复注入问题
  - 添加兜底机制
  - 增强调试能力